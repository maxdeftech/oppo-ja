# Oppo-JA / MaxwellConnect — Project Walkthrough (learning guide)
This repo is a Vite + React + TypeScript single-page app (SPA). There is **no separate backend server in this repo**. Instead, the browser app talks directly to **Supabase** (Auth + Postgres via PostgREST).

This document does two things:
1. Explains **how the whole system functions** (what communicates with what).
2. Gives **line-by-line explanations** for the most important files (and “guided tours” for very large files).

If you want, I can generate a *second* doc later that goes even deeper into `App.tsx` (it’s ~1855 lines, so a literal “every line” explanation becomes massive).

## 1) High-level mental model
### Runtime data flow (what talks to what)
At runtime in the browser:
- `index.html` loads `index.tsx`
- `index.tsx` mounts `<App />` into the DOM
- `App.tsx` renders pages and UI. It calls functions in `/api/*.ts` to read/write data.
- `/api/*.ts` calls the **Supabase JS client** from `lib/supabaseClient.ts`
- Supabase JS client talks over HTTPS/WebSocket to:
  - Supabase Auth (login/signup/session)
  - Supabase PostgREST (database queries/mutations)
- Supabase enforces permissions using **Row Level Security (RLS)** policies defined in `supabase-schema.sql`

A simple diagram:
- Browser UI (`App.tsx`) → API module (`api/*.ts`) → Supabase client (`lib/supabaseClient.ts`) → Supabase cloud → Postgres tables

### Navigation model
This app does **not** use React Router. Instead:
- `App.tsx` stores a `currentPage` string in state
- clicking nav buttons calls `setCurrentPage('some-page')`
- `renderContent()` in `App.tsx` switches on `currentPage` and returns the appropriate “page component”

## 2) Repo map (what each file/folder is)
### Root files
- `index.html`: the HTML shell (the page the browser loads).
- `index.tsx`: React entrypoint (mounts the app).
- `App.tsx`: the entire app UI + pages + logic (large single-file approach).
- `index.css`: Tailwind import + some global styles.
- `vite.config.ts`: Vite build/dev server config.
- `tsconfig.json`: TypeScript configuration.
- `tailwind.config.js`: Tailwind theme + scan paths.
- `postcss.config.js`: PostCSS config used by Tailwind.
- `types.ts`: UI-facing enums and interfaces.
- `types/database.ts`: Supabase table typings used by the Supabase client.
- `constants.ts`: enums exported as arrays, plus some mock sample data.
- `supabase-schema.sql`: database schema + RLS policies + auth trigger.
- `README.md`, `SETUP.md`: setup notes.
- `TYPESCRIPT_ERRORS.md`: explanation of the “never” type issues when schema isn’t applied.

### Folders
- `api/`: “data access layer” (functions that query/insert/update Supabase tables).
- `lib/`: shared libraries (currently the Supabase client).
- `components/`: reusable UI components (currently `Layout.tsx`).
- `public/`: static assets served as-is in dev and included in builds.
- `docs/`: build output folder (generated by `npm run build`, intended for GitHub Pages).

## 3) Boot sequence (from browser load to UI)
### Step-by-step
1. Browser opens `index.html`
2. `<script type="module" src="/index.tsx">` loads your TypeScript entrypoint
3. `index.tsx`:
   - finds `#root`
   - creates a React root
   - renders `<App />` wrapped in `<React.StrictMode>` and an `ErrorBoundary`
4. `App.tsx`:
   - checks Supabase env configuration (so you get a friendly error screen if missing)
   - reads session state from Supabase
   - subscribes to Supabase auth changes
   - renders pages based on `currentPage`

## 4) Line-by-line walkthroughs (key files)
This section is intentionally “close to the code” and references line numbers.

### 4.1 `vite.config.ts` (Vite configuration)
File: `vite.config.ts`
- Line 1: import Node’s `path` library to compute absolute paths.
- Line 2: import Vite helpers: `defineConfig` (typed config) and `loadEnv` (reads `.env*`).
- Line 3: import the React plugin (enables Fast Refresh, JSX transform, etc.).
- Lines 5–27: export config as a function so it can read `mode` (`development`, `production`, etc.).
  - Line 6: `loadEnv(mode, '.', '')` loads environment variables.
  - Lines 8–11: dev server configuration.
    - port `3000`
    - host `0.0.0.0` (binds on all interfaces)
  - Line 12: enables React plugin.
  - Lines 13–16: `define` replaces identifiers at build time.
    - It injects `env.GEMINI_API_KEY` into `process.env.*` placeholders.
    - This is a “Vite trick” because Vite normally uses `import.meta.env`, not `process.env`.
  - Lines 17–21: path alias so `@/foo` can map to the project root.
  - Lines 22–24: build output goes to `docs/` (GitHub Pages style).
  - Line 25: `base: './'` makes asset paths relative (important for GitHub Pages).

### 4.2 `index.html` (the HTML shell)
File: `index.html`
- Line 1–2: standard HTML document.
- Lines 4–13: `<head>` contains metadata and includes fonts.
- Lines 7–8: Content-Security-Policy header (security sandbox). This affects what external resources can be loaded.
- Line 16: `<div id="root"></div>` is where React mounts.
- Line 17: `<script type="module" src="/index.tsx"></script>` is the entrypoint.

### 4.3 `index.tsx` (React mount + ErrorBoundary)
File: `index.tsx`
- Lines 1–4: import React, ReactDOM, the `App` component, and global CSS.
- Lines 6–9: find the `#root` element, throw if missing.
- Lines 11–18: TypeScript interfaces for ErrorBoundary.
- Lines 20–58: `ErrorBoundary` component:
  - Line 29–31: when a child throws, React calls `getDerivedStateFromError` to flip `hasError`.
  - Line 33–35: `componentDidCatch` logs details.
  - Lines 37–57: render fallback UI or children.
- Lines 60–67: create the React root and render:
  - `StrictMode` helps catch unsafe patterns in development.
  - `ErrorBoundary` catches rendering/runtime errors in React components.

### 4.4 `lib/supabaseClient.ts` (Supabase client)
File: `lib/supabaseClient.ts`
- Line 1: import `createClient` from Supabase JS.
- Line 2: import `Database` TypeScript type so queries can be typed.
- Lines 4–5: read environment variables (Vite style):
  - `import.meta.env.VITE_SUPABASE_URL`
  - `import.meta.env.VITE_SUPABASE_ANON_KEY`
- Lines 7–9: if missing, log an error.
- Lines 11–13: placeholders are used if env vars are missing, so the app doesn’t crash immediately.
  - Note: you still *block the app* in `App.tsx` via `isSupabaseConfigured()`.
- Lines 15–21: create and export `supabase` client:
  - `autoRefreshToken`, `persistSession`, `detectSessionInUrl` enable typical SPA auth behavior.
- Lines 24–31: `isSupabaseConfigured()`:
  - logs debug info
  - returns “truthy” only if both real env vars exist

### 4.5 `types.ts` (UI types)
File: `types.ts`
- Lines 1–8: `UserRole` enum. Used all over UI for role gating.
- Lines 18–23: `JobType` enum used in UI. Notice values like `'Full-time'`.
  - In the DB, job types are stored as `'full_time'`, so the API does conversion.
- Lines 25–40: Jamaica parishes.
- Lines 42–57: `User` interface: UI-friendly shape (role is `UserRole`, verified flags, etc.).

## 5) Data-access layer (`api/`): what each module does
All `api/*.ts` modules import `supabase` from `lib/supabaseClient.ts` and operate on a table.

### 5.1 `api/auth.ts` (Auth + profile fetch/update)
File: `api/auth.ts`
- Purpose: wrap Supabase Auth functions and pair them with a `public.users` profile row.

Key functions:
- `signUp(data)`:
  - Calls `supabase.auth.signUp(...)` and puts profile fields in `options.data` (user metadata).
  - Then waits ~1s and fetches the corresponding row from `users` table.
  - If there’s no session yet (email verification pending), it returns a placeholder “profile” object so the UI can show “check your email”.
  - Important external dependency: the trigger `public.handle_new_user()` in `supabase-schema.sql`.
- `signIn(data)`:
  - Calls `supabase.auth.signInWithPassword(...)`.
  - Fetches the matching `users` table row.
- `getCurrentUser()`:
  - Calls `supabase.auth.getUser()`.
  - If a user exists, fetches the profile row.
  - Has defensive logic for missing sessions and invalid refresh tokens.
- `updateProfile(userId, updates)`:
  - Updates `users` row with `updated_at`.
- `onAuthStateChange(callback)`:
  - Subscribes to Supabase auth events.
  - If there is a session user, it calls `getCurrentUser()` and passes it to your callback.

### 5.2 `api/jobs.ts` (Job listings)
File: `api/jobs.ts`
- Main table: `job_listings`

Key functions:
- `getJobs(filters)`:
  - Builds a Supabase query and optionally filters by `location` and `type`.
  - Converts UI job types like `"Full-time"` or `"full-time"` into DB values like `full_time`.
- `getJobById(id)`:
  - Fetches one job.
- `createJob(businessId, jobData)`:
  - Inserts a row into `job_listings`.
- `updateJob(id, updates)`:
  - Updates job fields.
- `deleteJob(id)`:
  - Soft-delete by setting status to `'closed'`.
- `getFeaturedJobs(limit)`:
  - Filters `is_featured=true`.

### 5.3 `api/applications.ts` (Applications)
File: `api/applications.ts`
- Main table: `applications`

Key functions:
- `submitApplication(data)`:
  - First checks if an application already exists.
  - If not, inserts a new application row.
- `getUserApplications(userId)`:
  - Returns applications and joins job info via `job_listings (...)`.
- `getJobApplications(jobId)`:
  - Returns applications and joins user info via `users (...)`.
- `updateApplicationStatus(applicationId, status)`:
  - Updates status.

### 5.4 `api/verifications.ts` (Business verification workflow)
File: `api/verifications.ts`
- Main table: `verification_requests`

Key functions:
- `submitVerificationRequest(data)`:
  - Inserts a pending request.
- `getPendingVerifications()`:
  - Admin view: fetch all pending requests plus user info.
- `approveVerification(requestId, adminId)`:
  - Marks the request approved and sets reviewer fields.
  - Then sets `users.verified = true`.
- `rejectVerification(requestId, adminId)`:
  - Marks request rejected.

### 5.5 `api/savedJobs.ts` (Bookmarks)
File: `api/savedJobs.ts`
- Main table: `saved_jobs`

Key functions:
- `saveJob(userId, jobId)` inserts a row (or returns existing).
- `unsaveJob(userId, jobId)` deletes that row.
- `getSavedJobs(userId)` returns saved jobs and joins `job_listings`.
- `isJobSaved(userId, jobId)` checks for existence.

### 5.6 `api/admin.ts` (Admin/CEO operations)
File: `api/admin.ts`
- Main table: mostly `users`
- Notes: some things are “mock” (purge/backup), and some aggregation uses count queries.

## 6) The “pages” and UI wiring (`App.tsx` + `components/Layout.tsx`)
### 6.1 `components/Layout.tsx` (shared chrome)
File: `components/Layout.tsx`
- Lines 16–22: `LayoutProps` defines what `Layout` needs: `user`, `onLogout`, navigation state.
- Line 27: `navItems` is the “routing menu”, with a list of allowed roles per item.
- Lines 34–38: `filteredNavItems` filters nav items based on whether a user is logged in and their role.
- Lines 40–199: render layout:
  - Navbar (desktop + mobile)
  - Main content (`{children}`)
  - Footer

### 6.2 `App.tsx` (guided tour; too large for literal line-by-line)
File: `App.tsx`
`App.tsx` contains both “components” and “pages” in one file.

Important section markers (component start lines):
- `JobCard` starts at `App.tsx:43`
- `LandingPage` starts at `App.tsx:98`
- `AuthPage` starts at `App.tsx:197`
- `JobSearchPage` starts at `App.tsx:385`
- `AdminDashboard` starts at `App.tsx:529`
- `PostJobPage` starts at `App.tsx:752`
- `JobDetailsPage` starts at `App.tsx:905`
- `UserDashboard` starts at `App.tsx:974`
- `CEODashboard` starts at `App.tsx:1289`
- Main `App()` starts at `App.tsx:1653`

#### What the main `App()` does
File region: `App.tsx (1653-1855)`
- `currentPage` is the “router” state.
- `user` holds the logged-in user (or `null`).
- `loading` shows a full-screen spinner while auth check runs.

Key flow:
- `isSupabaseConfigured()` check:
  - If env vars are missing, it renders a friendly error screen rather than letting the app misbehave.
- `useEffect` (auth bootstrap and subscription):
  - Calls `checkAuth()` once to load existing session.
  - Subscribes to auth state changes via `authApi.onAuthStateChange(...)`.
  - When auth changes, it decides which page to show:
    - CEO → `'ceo'`
    - Admin → `'admin'`
    - Everyone else → `'dashboard'`
    - Logged out → `'home'`
- `renderContent()`:
  - A big `switch(currentPage)` deciding which page component to render.
- Final return:
  - Wraps content in `<Layout ...>` and passes:
    - `user`
    - `onLogout`
    - `currentPage`
    - `onNavigate` (just `setCurrentPage`)

#### Examples of “who calls who” inside `App.tsx`
- `AuthPage` calls:
  - `authApi.signUp(...)` or `authApi.signIn(...)`
  - then calls `onLogin(...)` which updates `App` state
- `JobSearchPage` calls:
  - `jobsApi.getJobs({ parish, type })`
  - transforms DB row shape (`company_name`) into UI shape (`companyName`)
- `AdminDashboard` calls:
  - `verificationsApi.getPendingVerifications()`
  - `adminApi.getAllUsers()`
  - approval/rejection calls `verificationsApi.approveVerification(...)` etc.
- `CEODashboard` calls:
  - `adminApi.getPlatformStats()`
  - `adminApi.getAllUsers()`
  - `adminApi.getPendingAdmins()`
  - `verificationsApi.getPendingVerifications()`

## 7) Database schema + security (Supabase)
File: `supabase-schema.sql`

### Tables
- `users`: profile rows (role, verified, TRN masked/encrypted, etc.)
- `job_listings`: job posts
- `applications`: job applications
- `verification_requests`: business verification workflow
- `saved_jobs`: bookmarks

### RLS (Row Level Security) is the main “backend security”
Your app runs in the browser, so Supabase must enforce security rules.
In `supabase-schema.sql`:
- Users can update their own profile (`auth.uid() = id`).
- Anyone can view active jobs (`job_listings.status = 'active'`).
- Only the business that owns a job can update/delete it.
- Applications:
  - job seeker can see their applications
  - business owner can see apps for their job
- Verifications:
  - user can create/view their own requests
  - admin/staff/ceo can view/update all requests
- Saved jobs:
  - only a user can view/insert/delete their own saved job rows

### Trigger: auto-create profile on sign-up
At the bottom of `supabase-schema.sql`:
- `public.handle_new_user()` inserts into `public.users` when a new auth user is created.
- Trigger `on_auth_user_created` runs after insert on `auth.users`.
This is why `api/auth.ts` expects “a moment later” the `users` row exists.

## 8) Styling and build
- Tailwind is enabled via `index.css` (`@import "tailwindcss";`).
- Tailwind theme customizations are in `tailwind.config.js`.
- Vite builds to `docs/` (static site output).

## 9) Suggested learning path (using this repo)
If your goal is to learn web dev, here’s a good order:
1. Start at `index.html` → `index.tsx` → `App.tsx:1653` (boot + navigation).
2. Learn component props and state by reading `components/Layout.tsx`.
3. Learn client-side data fetching by tracing a feature:
   - “Browse jobs” → `JobSearchPage` → `api/jobs.ts` → `lib/supabaseClient.ts`
4. Learn auth by tracing:
   - `AuthPage` → `api/auth.ts` → `supabase-schema.sql` trigger/RLS

If you tell me which feature you want to understand first (auth, jobs, applications, admin), I can create a second file that does a very deep, almost line-by-line walkthrough for just that slice.